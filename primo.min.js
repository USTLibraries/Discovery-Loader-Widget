/*
	Discovery Loader Widget (Primo)
	University of St. Thomas Libraries
	August 20, 2019

	Full Code and Documentation available at:
	https://github.com/USTLibraries/Discovery-Loader-Widget

	Primo Search Box Documentation:
	https://knowledge.exlibrisgroup.com/Primo/Product_Documentation/New_Primo_User_Interface/New_UI_Customization_-_Best_Practices#Creating_a_Search_Box_With_Deep_Links_to_the_New_UI


*/

/*
****************************************************************************
* Custom settings for Discovery-Loader-Widget
*
* discoveryCustomSettings will be passed to the Discovery-Loader-Widget function in primo[.min].js
*/

// Wondering what some of these values should be?
// Do a search in Primo and look at the query string in the URL of the results page
var discoveryCustomSettings = {
    css: 'https://s3.us-east-2.amazonaws.com/stthomas-libraries-assets-prod/assets/js/discovery/primo.min.css', // location of search box css file
    url: 'https://clicsearch.stthomas.edu', // base URL to your primo instance
    button_colors: '#510c76,#FFFFFF', // background and text hex color separated by comma '#FFFFFF,#000000'
    // primo values - many will be found in your query string or in Back Office
    instituion: '01CLIC_STTHOMAS',
    vid: 'STTHOMAS',
    tab: 'default_tab',
    search_scope: 'stthomas',
    bulkSize: '10',
    // look at this in the query string: facet=local1,include,My University Library
    localParam: 'local2', // for a localized search, what is the param? local1, local2?
    localDesc: 'University of St. Thomas', // the descriptor used for local resources
    // customized mapping
    facet_books: 'books', // can only include one material type, what type should BOOKS return?
    facet_audio: 'audio', // can only include one material type, what type should AUDIO return?
    facet_video: 'video', // can only include one material type, what type should VIDEO return?
    facet_music: 'score', // can only include one material type, what type should MUSIC return?
    facet_media: 'media', // can only include one material type, what type should AUVIS return?
    // default text for when data-something="default"
    default_tagline: 'Search the library catalog',
    default_placeholder: 'Find books, articles, movies, and more',
    default_placeholder_short: 'Keywords',
    default_advanced: 'More search options',
    default_login: 'My Account',
    default_button: 'Search', // Text for search button (there is no data- attr for this)
    default_label: 'Search', // Accessible label for screen readers (there is no data- attr for this)
    // custom link to place under search box
    custom_link_url: 'https://www.stthomas.edu/libraries/ask/clicsearch',
    custom_link_text: 'Feedback',
    // define narrow width - at what point does search box move from being a wide format to a narrow format when in tight places/columns?
    // goes by space allowed for search box, not screen width. Perfect for narrow columns
    // it resizes automatically if the browser window is resized (responsive)
    // wide format: search icon in left side of text search field, Search text in button
    // narrow format: no search icon in left side, but button becomes square with icon, no text. Perfect in small spaces/columns or screens
    narrow_max: 380 // Always want a mag icon for search button? set this extremly high! 9999
};


function searchPrimo(e){"use strict";document.getElementById(e+"-primoQuery").value="any,contains,"+document.getElementById(e+"-primoQueryTemp").value.replace(/[,]/g," "),document.forms[e+"-searchform"].submit()}function searchPrimoEnhanced(e){"use strict";var t="any",a=document.getElementById(e).getAttribute("data-scope");if(null!==a)switch(a.toLowerCase()){case"author":t="creator";break;case"title":t="title";break;case"journal":t="any";var r=document.getElementById(e+"-primoQueryTemp").value.replace(/[,]/g," ");document.getElementById(e+"-primoQueryjournals").value="any,"+r;break;case"course_name":t="crsname";break;case"course_instr":t="crsinstrc";break;case"course_id":t="crsid";break;case"course_dept":t="crsdept"}document.getElementById(e+"-primoQuery").value=t+",contains,"+document.getElementById(e+"-primoQueryTemp").value.replace(/[,]/g," "),document.forms[e+"-searchForm"].submit()}!function(e){"use strict";const t=discoveryCustomSettings;var a=function(e){var t=new Date,a=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+"."+t.getMilliseconds();console.log("DISCOVERY ["+a+"] : "+e)},r=function(){var e=document.getElementsByClassName("discovery-search-widget");if(e.length>0){var r=e[0].getElementsByTagName("label")[0];if("-10022px"!==window.getComputedStyle(r,null).getPropertyValue("left")){a("Adding css: "+t.css);var i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=t.css,document.getElementsByTagName("head")[0].appendChild(i)}else a("Discovery css detected")}};if(a("Loaded Discovery Loader Widget (Primo) (github.com/USTLibraries/Discovery-Loader-Widget) [ver0.0.50-20190820]"),null!==t&&"YOUR_INSTITUTION"!==t.instituion)if("undefined"!=typeof $)$(document).ready(function(){!function(e){e.fn.discoverySearchWidget=function(){return this.each(function(){var r=function(e){return null!=e&&""!==e&&"false"!==e.toLowerCase()&&"no"!==e.toLowerCase()},i=function(e){return"default"===e.toLowerCase()},n=function(t){return e("div#"+t).length<2},o=function(t,a,r){var i=document.createElement("input");return e(i).attr({type:"hidden",name:t,value:a}),void 0!==r&&e(i).attr(r),i},s=e(this).attr("id");if(!r(s)||!n(s)){a("Search Widget with no-ID/non-unique ID detected ("+s+")... assigning a unique ID"),r(s)||(s="discoverySearch");var c="";do{c=s+"_"+Math.floor(1e3*Math.random()+1)}while(!n(c));s=c,e(this).attr("id",s),a("Search Widget id reassigned: "+s)}var d="",l=document.createElement("form");e(l).attr({id:s+"-searchForm",method:"GET",name:"primoSearch",target:"_blank",action:t.url+"/primo-explore/search",class:"discovery-search-box",enctype:"application/x-www-form-urlencoded; charset=utf-8",onsubmit:"searchPrimoEnhanced('"+s+"')"});var u=document.createElement("input");if(e(u).attr({id:s+"-primoQueryTemp",type:"search",name:"primoQueryTemp",autocomplete:"off",class:"discovery-search-field"}),r(d=e(this).attr("data-placeholder"))){var m=t.default_placeholder;i(d)||(m=d),e(u).attr("placeholder",m)}e(u).keydown(function(t){if(13===t.keyCode)return e(this).trigger("keyup"),searchPrimoEnhanced(s),!1});var p=document.createElement("label");e(p).attr("for",s+"-primoQueryTemp").html(t.default_label);var h=[];(h.push(o("institution",t.instituion)),h.push(o("vid",t.vid)),h.push(o("tab",t.tab)),h.push(o("search_scope",t.search_scope)),h.push(o("bulkSize",t.bulkSize)),h.push(o("mode","Basic")),h.push(o("displayMode","full")),h.push(o("highlight","true")),h.push(o("dum","true")),h.push(o("query","",{id:s+"-primoQuery"})),h.push(o("displayField","all")),h.push(o("pcAvailabiltyMode","true")),r(d=e(this).attr("data-scope-content-type")))&&(y=(d=d.toLowerCase()).trim().split(",")).forEach(function(e){var a="";switch(e=e.trim()){case"book":case"books":a=t.facet_books;break;case"audio":a=t.facet_audio;break;case"video":a=t.facet_video;break;case"music":a=t.facet_music;break;case"media":a=t.facet_media;break;default:a=e}h.push(o("mfacet","rtype,include,"+a+",1"))});if(r(d=e(this).attr("data-scope-subj-terms")))for(var v=0,f=(y=(d=d.toLowerCase()).trim().split(",")).length;v<f;v++)h.push(o("mfacet","topic,include,"+y[v].trim()));if(r(d=e(this).attr("data-scope-discipline")))for(v=0,f=(y=(d=d.toLowerCase()).trim().split(",")).length;v<f;v++)h.push(o("mfacet","topic,include,"+y[v].trim()));if(r(d=e(this).attr("data-scope-language")))for(v=0,f=(y=(d=d.toLowerCase()).trim().split(",")).length;v<f;v++)h.push(o("mfacet","lang,exact,"+y[v].trim()));if(r(d=e(this).attr("data-scope-date"))){var y;""===(y=(d=d.toLowerCase().replace(/-/g,"")).trim().split(":"))[0]&&(y[0]=0),""===y[1]&&(y[1]=(new Date).getFullYear());var g="searchcreationdate,include,"+y[0].substring(0,4)+"|,|"+y[1].substring(0,4);h.push(o("mfacet",g))}r(d=e(this).attr("data-scope-fulltext"))&&h.push(o("mfacet","tlevel,include,online_resources")),r(d=e(this).attr("data-scope-local"))&&h.push(o("mfacet",t.localParam+",include,"+t.localDesc)),r(d=e(this).attr("data-scope-scholarly"))&&h.push(o("mfacet","tlevel,include,peer_reviewed"));var b=document.createElement("input");if(e(b).attr({type:"submit",name:"search",value:"Search",class:"discovery-search-button",id:"go",title:"Search",onclick:"searchPrimoEnhanced('"+s+"')",alt:"Search"}),""!==t.button_colors){var w=t.button_colors.split(",");w.length>1&&e(b).css({"background-color":w[0],color:w[1]})}var _=null;if(r(d=e(this).attr("data-tagline"))){m=t.default_tagline;i(d)||(m=d),_=document.createElement("p"),e(_).addClass("discovery-tagline"),e(_).html(m)}var E=null;if(r(d=e(this).attr("data-advanced"))){m=t.default_advanced;i(d)||(m=d),E=document.createElement("li");var k=document.createElement("a");e(k).attr("href",t.url+"/primo-explore/search?mode=advanced&vid="+t.vid),e(k).html(m),e(k).appendTo(E)}var C=null;if(r(d=e(this).attr("data-login"))){m=t.default_login;i(d)||(m=d),C=document.createElement("li");k=document.createElement("a");e(k).attr("href",t.url+"/primo-explore/account?section=overview&vid="+t.vid),e(k).html(m),e(k).appendTo(C)}var T=null;if(r(d=e(this).attr("data-custom-link"))){m=t.custom_link_text;i(d)||(m=d);var S=t.custom_link_url;r(d=e(this).attr("data-custom-link-url"))&&(S=d),T=document.createElement("li");k=document.createElement("a");e(k).attr("href",S),e(k).html(m),e(k).appendTo(T)}var x=null;null===C&&null===E&&null===T||(x=document.createElement("ul"),e(x).addClass("discovery-links"),null!==E&&e(E).appendTo(x),null!==C&&e(C).appendTo(x),null!==T&&e(T).appendTo(x));var L=document.createElement("div");e(L).attr({id:s+"-autosuggest",class:"discovery-search-autosuggest"}),e(l).append(p),e(l).append(u),e(l).append(h),e(l).append(b),e(this).html(l),null!==_&&e(this).prepend(_),null!==x&&e(this).append(x),null!==L&&e(this).append(L),r(d=e(this).attr("data-scope"))&&("journal"===d.toLowerCase()?(a("Morphing ["+s+"] into a Journal Title search box"),e(l).find("input[name='search_scope']").detach(),e(l).find("input[name='mode']").detach(),e(l).find("input[name='tab']").attr("value","jsearch_slot"),e(l).attr("action",t.url+"/primo-explore/jsearch"),e(l).append(o("journals","",{id:s+"-primoQueryjournals"}))):"course"===d.toLowerCase().substr(0,6)&&(a("Morphing ["+s+"] into a Course Reserve search box"),e(l).find("input[name='search_scope']").attr("value",t.search_scope+"_course"),e(l).find("input[name='tab']").attr("value","course_tab"))),void 0!==e.fn.autocomplete?(e(u).autocomplete({source:function(a,r){e.ajax({url:t.url+"/metadata/suggest/suggest",dataType:"jsonp",data:{type_strict:"should",all_types:"true",prefix:a.term},success:function(t){r(e.map(t.result,function(e){return{label:e.name,value:e.name}}))}})},minLength:2,delay:300,appendTo:e(L)}),a("jQuery ui AVAILABLE, autosuggest ENABLED for: #"+e(this).attr("id"))):a("jQuery ui NOT available, autosuggest NOT enabled for: #"+e(this).attr("id"))})},e.fn.discoverySearchCheckWidth=function(){return this.each(function(){var a=t.narrow_max,r=e(this).outerWidth(!0),i=!0;r<a&&(i=!1),e(this).attr("data-calc-width","Needed: "+a+" | Current: "+r+" | Enough Room?: "+i),i?e(this).removeClass("discovery-narrow-width").addClass("discovery-wide-width"):e(this).removeClass("discovery-wide-width").addClass("discovery-narrow-width")})}}(jQuery);var e=new Date;a("Starting..."),$("div.discovery-search-widget").discoverySearchWidget(),r(),$("div.discovery-search-widget").discoverySearchCheckWidth(),$(window).resize(function(){$("div.discovery-search-widget").discoverySearchCheckWidth()});var i=Math.abs(new Date-e);a("Done. Completed in "+i+" milliseconds")});else{a("jQuery and jQuery UI required to generate dynamic discovery search box. Generic search box generated instead."),a("Starting...");for(var i=new Date,n=document.getElementsByClassName("discovery-search-widget"),o=0,s=n.length;o<s;o++){var c=n[o].getAttribute("id")+"-js"+o,d=" <form class='discovery-search-box' action='"+t.url+"/primo-explore/search' \n       target='_blank' enctype='application/x-www-form-urlencoded; charset=utf-8' onsubmit=\"searchPrimo('"+c+"')\"       name='primoSearch' method='GET' id='"+c+"-searchform'>     <label for='"+c+"-primoQueryTemp'>"+t.default_label+"</label>     <input placeholder='"+t.default_placeholder+"' class='discovery-search-field'        autocomplete='off' name='primoQueryTemp' id='"+c+"-primoQueryTemp' type='search'>     <input type='hidden' name='institution' value='"+t.instituion+"'>     <input type='hidden' name='vid' value='"+t.vid+"'>     <input type='hidden' name='tab' value='"+t.tab+"'>     <input type='hidden' name='search_scope' value='"+t.search_scope+"'>     <input type='hidden' name='mode' value='Basic'>     <input type='hidden' name='displayMode' value='full'>     <input type='hidden' name='bulkSize' value='"+t.bulkSize+"'>     <input type='hidden' name='highlight' value='true'>     <input type='hidden' name='dum' value='true'>     <input type='hidden' name='query' id='"+c+"-primoQuery'>     <input type='hidden' name='displayField' value='all'>     <input type='hidden' name='pcAvailabiltyMode' value='true'>     <input id='go' title='"+t.default_button+"' onclick=\"searchPrimo('"+c+"')\"            alt='"+t.default_button+"' class='discovery-search-button'            value='"+t.default_button+"' name='search' type='submit'> </form> \t\t";n[o].innerHTML=d}r();var l=Math.abs(new Date-i);a("Done. Completed in "+l+" milliseconds")}else a("discoveryCustomSettings not properly set")}();